spack:
  view: false
  packages:
    all:
      require: target=x86_64_v3
    py-torch:
      # Does not yet support Spack-installed ROCm
      require: ~rocm
    llvm:
      # https://github.com/spack/spack/issues/27999
      require: ~cuda
      variants: "~clang~lldb~lld~polly+llvm_dylib+link_llvm_dylib libunwind=none libcxx=none targets=none"
    mpi:
      require: openmpi
    gl:
      require: osmesa
    mesa:
      require: "+osmesa~glx+llvm"

  definitions:
  - cuda_variants: # Enable/disable CUDA
    - +cuda cuda_arch=80
    - ~cuda
  - rocm_variants: # Enable/disable ROCm
    - +rocm amdgpu_target=gfx90a
    - ~rocm
  - gpu_variants: # Enable/disable ROCm and CUDA
    - +rocm amdgpu_target=gfx90a
    - +cuda cuda_arch=80
    - ~cuda ~rocm

  - horovod_specs:
    - matrix:
      - - py-horovod
      - [$cuda_variants]

  - jax_specs:
    - matrix:
      - - py-jaxlib
      - [$cuda_variants]
    - py-jax

  - hugging_face_specs:
    - py-transformers

  - keras_specs:
    - py-keras
    - py-keras-applications
    - py-keras-preprocessing
    - py-keras2onnx

  - mxnet_specs:
    - mxnet

  - pytorch_specs:
    - py-botorch
    - py-efficientnet-pytorch
    - py-gpytorch
    - py-kornia
    - py-lightning
    - py-pytorch-gradual-warmup-lr
    - py-pytorch-lightning
    - py-segmentation-models-pytorch
    - py-timm
    - py-torch-cluster
    - py-torch-scatter
    - py-torch-geometric
    - py-torch-sparse
    - py-torch-spline-conv
    - py-torchaudio
    - py-torchdata
    - py-torchfile
    - py-torchgeo
    - py-torchmetrics
    - py-torchtext
    - py-torchvision
    - py-vector-quantize-pytorch
    # GPU Specs
    # PyTorch packages do not support Spack built ROCm
    # so only configure CUDA and CPU versions
    - matrix:
      - - py-torch
        - py-torch-nvidia-apex
      - - $cuda_variants

  - scikit_learn_specs:
    - py-scikit-learn
    - py-scikit-learn-extra

  - tensorboard_specs:
    - py-tensorboard
    - py-tensorboard-data-server
    - py-tensorboard-plugin-wit
    - py-tensorboardx

  - tensorflow_specs:
    - py-tensorflow-datasets
    - py-tensorflow-estimator
    - py-tensorflow-hub
    - py-tensorflow-metadata
    - py-tensorflow-probability
    - matrix:
      - - py-tensorflow
      - - $gpu_variants

  - xgboost_specs:
    - py-xgboost
    # - r-xgboost
    - matrix:
      - - xgboost
      - - $cuda_variants

  specs:
    # Horovod
    - $horovod_specs

    # Hugging Face
    - $hugging_face_specs

    # JAX
    - $jax_specs

    # Keras
    - $keras_specs

    # MXNet
    - $mxnet_specs

    # PyTorch
    - $pytorch_specs

    # scikit-learn
    - $scikit_learn_specs

    # TensorBoard
    - $tensorboard_specs

    # TensorFlow
    - $tensorflow_specs

    # XGBoost
    - $xgboost_specs

  mirrors:
    mirror: s3://spack-binaries/develop/ml-linux-x86_64-cpu

  ci:
    pipeline-gen:
    - build-job:
        image:
          name: ghcr.io/spack/linux-ubuntu22.04-x86_64_v2:v2023-07-01
          entrypoint: ['']

  cdash:
    build-group: Machine Learning
